# 阿里云短信验证码### 一、安装和配置1. 安装`www_fdw`    ```shell    $ git clone https://github.com/cyga/www_fdw.git    $ cd www_fdw    $ export PATH=/Applications/Postgres.app/Contents/Versions/10/bin:$PATH    $ export USE_PGXS=1    $ make && make install    ```2. 进入`PostgreSQL`命令行，创建`www_fdw`扩展    ```sql    DROP EXTENSION IF EXISTS www_fdw CASCADE;    CREATE EXTENSION www_fdw;    ```3. 创建`SERVER`和`FOREIGN TABLE`    ```sql    CREATE SERVER www_fdw_ailiyun_smscode_server FOREIGN DATA WRAPPER www_fdw    OPTIONS (uri 'http://dysmsapi.aliyuncs.com');    CREATE USER MAPPING FOR current_user SERVER www_fdw_ailiyun_smscode_server;    CREATE FOREIGN TABLE www_fdw_ailiyun_smscode (        "RequestId" VARCHAR(100),        "Code" VARCHAR(50),        "Message" VARCHAR(200),        "BizId" VARCHAR(100)    ) SERVER www_fdw_ailiyun_smscode_server;    ```4. 导入`pgsql.sql`### 二、发送短信验证码和校验验证码的合法性1. 配置阿里云短信验证码    ```sql    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('AccessKeyId', 4, '----------', '');    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('AccessKeySecret', 4, '------------------------------', '');    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('SignName', 4, 'APP名称', '');    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('TemplateCode', 4, 'SMS_？？？？？？？？', '');    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('format', 4, 'JSON', '');    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('signatureMethod', 4, 'HMAC-SHA1', '');    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('signatureVersion', 4, '1.0', '');    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('HTTPMethod', 4, 'GET', '');    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('regionId', 4, 'cn-hangzhou', '');    INSERT INTO base_config(c_key, c_cid, c_value, description) VALUES ('version', 4, '2017-05-25', '');    ```2. 发送短信验证码    ```sql    SELECT logic_ailiyun_smscode(json_build_object(      'mobile', '接收短信验证码的手机号码',      'usefor', '发送类型，默认：register',      'uuid', '用户uuid，默认：随机UUID',      'code', '指定短信验证码，默认：随机验证码'     ));    ```3. 校验验证码的合法性    ```sql    SELECT logic_verify_smscode(json_build_object(      'request_id', '发送短信验证码请求ID',      'code', '短信验证码'     ));    ```