# 基于角色的权限访问控制----`RBAC`### 一、说明### 二、安装### 三、用户操作方法存储过程* 用户注册    * `mobile`：注册用手机号码    * `password`：用户注册密码    * `recip`：用户IP地址    * `request_id`：手机验证码发送请求（在配置中设置了用户注册时通过短信验证，必填）    * `code`：手机验证码（在配置中设置了用户注册时通过短信验证，必填）    ```sql    SELECT logic_user_reister(      json_build_object(        'mobile', '13354631000',        'password', 'xx123456',        'recip', '127.0.0.1'      )    );    ```* 用户退出系统    * `uid`：用户uid    ```sql    SELECT logic_user_logout(2);    ```* 用户登录系统    * `mobile`：手机号码    * `password`：用户密码    * `recip`：用户IP地址    ```sql    SELECT logic_user_login(      json_build_object(          'mobile', '13354631000',          'password', 'xx123456',          'recip', '127.0.0.1'        )    );    ```* 用户找回密码     * `mobile`：手机号码    * `password`：用户密码    * `recip`：用户IP地址    * `request_id`：手机验证码发送请求（在配置中设置了用户忘记密码时通过短信验证，必填）    * `code`：手机验证码（在配置中设置了用户忘记密码时通过短信验证，必填）    ```sql    SELECT logic_user_forgot_password(      json_build_object(        'mobile', '13354631000',        'password', 'xx123456',        'recip', '127.0.0.1'      )    );    ```    * 用户重置密码    * `uid`：用户UID    * `password`：用户密码    * `recip`：用户IP地址    * `request_id`：手机验证码发送请求（在配置中设置了用户重置密码时通过短信验证，必填）    * `code`：手机验证码（在配置中设置了用户重置密码时通过短信验证，必填）    ```sql    SELECT logic_user_change_password(      json_build_object(        'uid', 2,        'password', 'xx123456',        'recip', '127.0.0.1'      )    );    ```    * 用户设置头像    * `uid`：用户UID    * `path`：上传头像的路径    * `md5`：上传头像的MD5信息    * `sha1`：上传头像的sha1信息    * `recip`：用户IP地址    ```sql    SELECT logic_user_set_headimg(      json_build_object(        'uid', 2,        'path', '/headimg/2018-10/2598756845.jpg',        'md5', 'md5',        'sha1', 'sha1',        'recip', '127.0.0.1'      )    );    ```* 用户设置昵称    * `uid`：用户UID    * `nickname`：用户昵称    * `recip`：操作者IP    ```sql    SELECT logic_user_change_nickname(               json_build_object(                   'uid', 2,                   'nickname', 'Gadfly',                   'recip', '127.0.0.1'               )            );    ```* 用户变更手机号码    * `uid`：用户UID    * `password` 用户登录密码    * `mobile`：用户手机号码    * `recip`：操作者IP    * `request_id`：手机验证码发送请求（在配置中设置了用户变更手机号码时通过短信验证，必填）    * `code`：手机验证码（在配置中设置了用户变更手机号码时通过短信验证，必填）    ```sql    SELECT logic_user_change_mobile(               json_build_object(                   'uid', 2,                   'password', 'xx123456',                   'mobile', '13354631001',                   'recip', '127.0.0.1'               )            );    ```* 用户获得积分    * `uid`：用户UID    * `credit`：获得的积分数量    * `info`：获得积分的原因    * `recip`：操作者IP    ```sql    SELECT logic_user_gain_credit(      json_build_object(        'uid', 2,        'credit', 5,        'info', '获得积分的理由',        'recip', '127.0.0.1'      )    );    ```    * 用户实名认证申请    * `uid`：用户UID    * `realname`：真实姓名    * `idcard`：身份证号码    * `nation`：民族，非必填    * `address`：住址，非必填    * `idcard`：身份证号码    * `front_path`：身份证正面图片路径    * `front_md5`：身份证正面图片的MD5    * `front_sha1`：身份证正面图片的SHA1    * `back_path`：身份证背面图片路径    * `back_md5`：身份证背面图片的MD5    * `back_sha1`：身份证背面图片的SHA1    * `recip`：用户IP地址    ```sql    SELECT logic_user_apply_realname(      json_build_object(        'uid', 1,        'realname', '真实姓名',        'idcard', '530103197510290651',        'front_path', '/card_front/2018-10/2598756845.jpg',        'front_md5', 'front_md5',        'front_sha1', 'front_sha1',        'back_path', '/card_back/2018-10/2598756845.jpg',        'back_md5', 'back_md5',        'back_sha1', 'back_sha1',        'recip', '127.0.0.1'      )    );    ```    * 后台审核用户真实姓名    * `id`：实名认证请求ID，必填    * `uid`：审核操作者UID，必填    * `result`：审核结果，只能是`success`或`fail`，必填    * `cause`：审核失败原因，当审核结果为`fail`时必填    * `recip`：审核操作者IP，必填    ```sql    SELECT logic_user_audit_realname(      json_build_object(        'id', 4,        'uid', 2,        'result', 'success',        'recip', '127.0.0.1'      )    );    ```    * 用户绑定微信    * `uid`：用户UID    * `weixin`：关注微信号，必填    * `openid`：用户微信移动应用`OpenID`，必填    * `unionid`：用户微信`unionid`    * `nickname`：用户昵称，必填    * `sex`：性别    * `language`：语言    * `city`：城市    * `province`：省份    * `country`：国家    * `headimgurl`：用户头像，必填    * `privilege`：用户特权信息    * `recip`：审核操作者IP，必填    ```sql    SELECT logic_user_bind_weixin(      json_build_object(        'uid', 1,        'weixin', 'webAPP',        'openid', 'sdgsdgsdgsdgsdgsdg',        'unionid', 'sdgsdgsdgsdgsdgsdgdsg',        'nickname', '微信昵称',         'sex', 1,        'language', 'china',        'city', 'kunming',        'province', 'yunnan',        'country', 'china',        'headimgurl', 'http://dsgsd.net/sdfsf.jpg',        'privilege', 'dsgsdgsdgsdgdsg'        'recip', '127.0.0.1'      )    )    ```* 变更用户所在用户组的操作    * `uid`：用户UID    * `gid`：用户组ID    * `recip`：审核操作者IP，必填    ```sql    SELECT logic_user_action_group(      json_build_object(        'uid', 1,        'gid', 2，        'recip', '127.0.0.1'      )    )    ```    * 新增用户组、新增系统菜单、新增系统页面、新增页面元素操作（操作成功后，再返回的JSON数据中返回权限配置数据）    * `json`：参数①，JSON数据格式        * `upid`：上级ID，默认：0        * `title`：用户组或系统菜单的名称，必填        * `subtitle`：用户组或系统菜单的子标题        * `description`：用户组或系统菜单的描述说明        * `icon`：用户组或系统菜单的图标样式名，多个样式名用空格区分        * `classes`：用户组或系统菜单的样式表CLASS名称，多个名称用空格区分        * `image`：用户组或系统菜单图片            * `path`：上传图片的服务器路径            * `md5`：上传图片的MD5信息            * `sha1`：上传图片的SHA1信息            * `uid`：上传图片操作用户的用户UID            * `recip`：上传图片操作用户的用户IP        * `sorts`：用户组或系统菜单的排序    * `type`：参数②，只能是`group`（用户组）、`menu`（系统菜单）、`page`（系统页面）、`element`（页面元素）    ```sql    -- 新增用户组    SELECT logic_group_menu_page_element(      json_build_object(        'upid', 0,        'identify', 'userGroupName',        'title', '用户组名称',        'subtitle', '用户组子标题',        'image', json_build_object(          'path', '/group/2018-10-29/sdfgsdfgds.jpg',          'md5', 'group_image_md5',          'sha1', 'group_image_sha1',          'uid', 2,          'recip', '127.0.0.1'        )      ), 'group');    -- 新增系统菜单    SELECT logic_group_menu_page_element(          json_build_object(            'upid', 0,            'identify', 'develop',            'title', '站点开发',            'subtitle', '管理后台站点开发'          ), 'menu');    -- 新增系统页面    SELECT logic_group_menu_page_element(      json_build_object(          'mid', 1,          'identify', 'develop',          'title', '站点开发页面',          'subtitle', '管理后台站点开发',          'is_default', TRUE        ), 'page');    -- 新增页面元素（数据结构）    SELECT logic_group_menu_page_element(      json_build_object(        'pid', 2,        'identify', 'develop',        'label', 'button',        'title', '页面元素标签',        'means', 'structure',        'structure', 'base_lottery',        'source_type', 'view',        'source', 'base_user_list_view'      ), 'element');    -- 新增页面元素（数据模型）    SELECT logic_group_menu_page_element(          json_build_object(            'pid', 2,            'identify', 'develop',            'label', 'button',            'title', '页面元素标签',            'means', 'action',            'procedure', 'logic_user_gain_credit'          ), 'element');    ```    * 保存权限配置数据操作    > 作用：用来保存 ①同一用户组的所有系统菜单权限；②同一系统菜单的所有用户组权限；③同一用户的所有额外菜单权限    * `JSON`：JSON数组格式参数    ```sql    SELECT logic_permission(               '[{"id":19,"uid":null,"gid":1,"mid":1,"pid":2,"eid":8,"allow":true}, {"id":20,"uid":null,"gid":2,"mid":1,"pid":2,"eid":8,"allow":true}, {"id":21,"uid":null,"gid":3,"mid":1,"pid":2,"eid":8,"allow":true}, {"id":22,"uid":null,"gid":4,"mid":1,"pid":2,"eid":8,"allow":true}]'                   )    ```